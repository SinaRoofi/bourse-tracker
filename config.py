"""
تنظیمات پروژه Bourse Tracker
"""
import os
from dotenv import load_dotenv

# بارگذاری متغیرهای محیطی از فایل .env
load_dotenv()

# ========================================
# تنظیمات تلگرام
# ========================================
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
TELEGRAM_CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')

# ========================================
# تنظیمات API
# ========================================
API_BASE_URL = os.getenv('API_BASE_URL')  # از .env یا GitHub Secrets می‌خونه

# کدهای صنایع مختلف بورس (تمام صنایع)
INDUSTRY_CODES = [
    '01', '10', '11', '13', '14', '17', '19', '20', '21', '22',
    '23', '25', '27', '28', '29', '31', '32', '34', '38', '39',
    '40', '42', '43', '44', '47', '49', '53', '54', '55', '56',
    '57', '58', '60', '64', '66', '67', '70', '72', '73', '74'
]

# نام صنایع (برای نمایش در گزارش‌ها)
INDUSTRY_NAMES = {
    '01': 'زراعت',
    '10': 'ذغال سنگ',
    '11': 'استخراج نفت جز کشف',
    '13': 'کانه فلزی',
    '14': 'سایر معادن',
    '17': 'منسوجات',
    '19': 'محصولات چرمی',
    '20': 'محصولات چوبی',
    '21': 'محصولات کاغذ',
    '22': 'انتشار و چاپ',
    '23': 'فرآورده نفتی',
    '25': 'لاستیک',
    '27': 'فلزات اساسی',
    '28': 'محصولات فلزی',
    '29': 'ماشین‌آلات',
    '31': 'دستگاه‌های برقی',
    '32': 'وسایل ارتباطی',
    '34': 'خودرو',
    '38': 'قند و شکر',
    '39': 'چند رشته‌ای صنعتی',
    '40': 'تامین آب، برق و گاز',
    '42': 'غذایی بجز قند',
    '43': 'مواد دارویی',
    '44': 'شیمیایی',
    '47': 'خرده‌فروشی',
    '49': 'کاشی و سرامیک',
    '53': 'سیمان',
    '54': 'کانی غیرفلزی',
    '55': 'هتل و رستوران',
    '56': 'سرمایه‌گذاری‌ها',
    '57': 'بانک‌ها',
    '58': 'سایر مالی',
    '60': 'حمل و نقل',
    '64': 'رادیویی',
    '66': 'بیمه و بازنشسته',
    '67': 'اداره بازارهای مالی',
    '70': 'انبوه‌سازی',
    '72': 'رایانه',
    '73': 'اطلاعات و ارتباطات',
    '74': 'فنی و مهندسی'
}

# ========================================
# تنظیمات فیلترها
# ========================================

# توجه: همه واحدها به میلیارد تومان و میلیون تومان تبدیل شده‌اند

# فیلتر 3: نمادهای خاص و درصد تغییر آستانه
WATCHLIST_SYMBOLS = {
    'فولاد': 2.99,      # اگه بیشتر از 3% رشد کرد
    'خودرو': 2.99      # اگه بیشتر از 2.5% رشد کرد
    'شپنا': 2.99       # اگه بیشتر از 4% رشد کرد
    'فملی': 2.99,       # اگه بیشتر از 3.5% رشد کرد
    # نمادهای دیگه رو اینجا اضافه کن
}

# فیلتر 4: صف خرید سنگین در سقف قیمت
CEILING_FILTER_CONFIG = {
    'price_range_percent': 3,         # دامنه نوسان (معمولاً 5% در بورس ایران)
    'min_buy_queue_value': 1.0,         # حداقل 1 میلیارد تومان صف خرید (واحد: میلیارد)
    'max_sell_queue_value': 0.01,       # حداکثر 10 میلیون تومان صف فروش (واحد: میلیارد)
}

# فیلتر 5: نسبت پول حقیقی به ارزش معاملات
POL_HAGIGI_FILTER_CONFIG = {
    'min_pol_to_value_ratio': 0.5,      # حداقل نسبت پول حقیقی به میانگین ماهانه
    'min_sarane_kharid': 50,           # حداقل 50 میلیون تومان سرانه خرید (واحد: میلیون)
    'min_godrat_kharid': 1.5,           # حداقل قدرت خرید
}

# فیلتر 6: تیک و ساعت (رشد قیمتی در آخر معاملات)
TICK_FILTER_CONFIG = {
    'first_to_low_ratio': 0.98,         # 0.98 * first_price > low_price
    'last_to_first_ratio': 0.98,        # 0.98 * last_price > first_price
    'tick_diff_percent': 2.0,           # last_change% - final_change% > 2%
}

# فیلتر 7: حجم مشکوک
SUSPICIOUS_VOLUME_CONFIG = {
    'min_value_to_avg_ratio': 2.0,      # حداقل نسبت ارزش به میانگین ماهانه
}

# فیلتر 8: نوسان‌گیری (خرید در کف)
SWING_TRADE_CONFIG = {
    'min_allowed_price': -3,          # حداقل آستانه مجاز (مثلاً -5% دامنه منفی)
    'max_last_change_percent': -2.0,    # درصد آخرین کمتر از -2%
    'min_godrat_kharid': 2.0,           # حداقل قدرت خرید
    'min_sarane_kharid': 50,           # حداقل 50 میلیون سرانه خرید (واحد: میلیون)
}

# فیلتر 9: یک ساعت اول (فقط 9:00 - 10:00)
FIRST_HOUR_CONFIG = {
    'min_value_to_avg_ratio': 1.0,      # ارزش معاملات به میانگین ماهانه >= 1
    'start_hour': 9,                     # ساعت شروع
    'end_hour': 10,                      # ساعت پایان
}

# ========================================
# زمان‌بندی
# ========================================
MARKET_START_TIME = "09:00"  # شروع بازار
MARKET_END_TIME = "12:30"    # پایان بازار
CHECK_INTERVAL_MINUTES = 5    # بررسی هر 5 دقیقه

# روزهای کاری (0=شنبه تا 6=جمعه)
WORKING_DAYS = [0, 1, 2, 3, 4]  # شنبه تا چهارشنبه

# ========================================
# تعطیلات رسمی سال 1404 (شمسی)
# ========================================
HOLIDAYS_1404 = [
    # نوروز
    '1404-01-01', '1404-01-02', '1404-01-03', '1404-01-04',
    
    # روز جمهوری اسلامی
    '1404-01-12',
    
    # سیزده به در
    '1404-01-13',
    
    # رحلت حضرت امام خمینی
    '1404-03-14',
    
    # قیام 15 خرداد
    '1404-03-15',
    
    # شهادت امام علی
    '1404-04-11',
    
    # عید فطر
    '1404-04-19', '1404-04-20',
    
    # شهادت امام صادق
    '1404-05-15',
    
    # عید قربان
    '1404-06-26',
    
    # عید غدیر
    '1404-07-04',
    
    # تاسوعا
    '1404-07-18',
    
    # عاشورا
    '1404-07-19',
    
    # اربعین
    '1404-08-28',
    
    # رحلت پیامبر و شهادت امام حسن
    '1404-09-08',
    
    # شهادت امام رضا
    '1404-09-10',
    
    # ولادت پیامبر
    '1404-09-17',
    
    # شهادت فاطمه زهرا
    '1404-11-20',
    
    # ولادت امام علی
    '1404-12-03',
    
    # مبعث
    '1404-12-15',
    
    # ولادت امام زمان
    '1404-12-25'
]

# ========================================
# ستون‌های دیتافریم
# ========================================
CSV_COLUMNS = [
    "id",
    "symbol",
    "volume",
    "value",
    "first_price",
    "first_price_change_percent",
    "high_price",
    "high_price_change_percent",
    "low_price",
    "low_price_change_percent",
    "last_price",
    "last_price_change_percent",
    "final_price",
    "final_price_change_percent",
    "diff_last_final",
    "volatility",
    "sarane_kharid",
    "sarane_forosh",
    "godrat_kharid",
    "pol_hagigi",
    "buy_order_value",
    "sell_order_value",
    "diff_buy_sell_order",
    "avg_5_day_pol_hagigi",
    "avg_20_day_pol_hagigi",
    "avg_60_day_pol_hagigi",
    "5_day_pol_hagigi",
    "20_day_pol_hagigi",
    "60_day_pol_hagigi",
    "5_day_godrat_kharid",
    "20_day_godrat_kharid",
    "avg_monthly_value",
    "value_to_avg_monthly_value",
    "avg_3_month_value",
    "value_to_avg_3_month_value",
    "5_day_return",
    "20_day_return",
    "60_day_return",
    "marketcap",
    "value_to_marketcap"
]

# ========================================
# تنظیمات لاگ
# ========================================
LOG_LEVEL = "INFO"
LOG_FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'

# ========================================
# اعتبارسنجی تنظیمات
# ========================================
def validate_config():
    """بررسی صحت تنظیمات"""
    errors = []
    
    if not TELEGRAM_BOT_TOKEN:
        errors.append("TELEGRAM_BOT_TOKEN تنظیم نشده است")
    
    if not TELEGRAM_CHAT_ID:
        errors.append("TELEGRAM_CHAT_ID تنظیم نشده است")
    
    if not API_BASE_URL:
        errors.append("API_BASE_URL تنظیم نشده است")
    
    if errors:
        raise ValueError("خطاهای تنظیمات:\n" + "\n".join(errors))
    
    return True